import { ClientChatSession } from '../model/ClientChatModels'
import { QAMessage } from '../model/QAMessage'
import { ChatMessage } from '../model/ChatModels'

export class ClientSessionManager {
  private sessions: ClientChatSession[] = []
  private currentSessionId: string = ''
  
  constructor() {
    this.loadSessions()
  }
  
  // ä»ŽAppStorageåŠ è½½ä¼šè¯
  loadSessions() {
    try {
      const storedSessions: ClientChatSession[] | null | undefined = AppStorage.Get('chatSessions')
      const storedCurrentId: string | null | undefined = AppStorage.Get('currentSessionId')
      
      if (storedSessions && Array.isArray(storedSessions)) {
        this.sessions = storedSessions as ClientChatSession[]
        // è½¬æ¢æ—¥æœŸå­—ç¬¦ä¸²å›žDateå¯¹è±¡
        this.sessions.forEach(session => {
          session.createdAt = new Date(session.createdAt)
          session.updatedAt = new Date(session.updatedAt)
        })
      }
      
      if (storedCurrentId && typeof storedCurrentId === 'string') {
        this.currentSessionId = storedCurrentId
      }
      
      // å¦‚æžœæ²¡æœ‰ä¼šè¯ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤ä¼šè¯
      if (this.sessions.length === 0) {
        this.createSession('æ–°å¯¹è¯')
      }
    } catch (error) {
      console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error)
      this.createSession('æ–°å¯¹è¯')
    }
  }
  
  // ä¿å­˜ä¼šè¯åˆ°AppStorage
  private saveSessions() {
    try {
      AppStorage.Set('chatSessions', this.sessions)
      AppStorage.Set('currentSessionId', this.currentSessionId)
    } catch (error) {
      console.error('ä¿å­˜ä¼šè¯å¤±è´¥:', error)
    }
  }
  
  // åˆ›å»ºæ–°ä¼šè¯
  createSession(title: string, bookName?: string): ClientChatSession {
    // å¦‚æžœæœ‰ä¹¦ç±åç§°ï¼Œä½¿ç”¨ä¹¦ç±åç§°ä½œä¸ºæ ‡é¢˜
    const sessionTitle = bookName ? `ðŸ“š ${bookName}` : title
    const newSession: ClientChatSession = {
      id: this.generateId(),
      title: sessionTitle,
      bookName: bookName,
      messages: [],
      createdAt: new Date(),
      updatedAt: new Date(),
      isActive: true
    }
    
    this.sessions.unshift(newSession)
    this.currentSessionId = newSession.id
    this.saveSessions()
    
    return newSession
  }
  
  // åˆ‡æ¢ä¼šè¯
  switchSession(sessionId: string): boolean {
    const session = this.sessions.find(s => s.id === sessionId)
    if (session) {
      this.currentSessionId = sessionId
      this.saveSessions()
      return true
    }
    return false
  }
  
  // åˆ é™¤ä¼šè¯
  deleteSession(sessionId: string): boolean {
    const index = this.sessions.findIndex(s => s.id === sessionId)
    if (index !== -1) {
      this.sessions.splice(index, 1)
      
      // å¦‚æžœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ªä¼šè¯
      if (sessionId === this.currentSessionId) {
        if (this.sessions.length > 0) {
          this.currentSessionId = this.sessions[0].id
        } else {
          this.createSession('æ–°å¯¹è¯')
        }
      }
      
      this.saveSessions()
      return true
    }
    return false
  }
  
  // èŽ·å–å½“å‰ä¼šè¯
  getCurrentSession(): ClientChatSession | null {
    return this.sessions.find(s => s.id === this.currentSessionId) || null
  }
  
  // èŽ·å–æ‰€æœ‰ä¼šè¯
  getAllSessions(): ClientChatSession[] {
    return this.sessions
  }
  
  // æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰ä¼šè¯
  addMessageToCurrentSession(message: QAMessage): void {
    const currentSession = this.getCurrentSession()
    if (currentSession) {
      currentSession.messages.push(message)
      currentSession.updatedAt = new Date()
      this.saveSessions()
    }
  }
  
  // æ¸…ç©ºå½“å‰ä¼šè¯æ¶ˆæ¯
  clearCurrentSessionMessages(): void {
    const currentSession = this.getCurrentSession()
    if (currentSession) {
      currentSession.messages = []
      currentSession.updatedAt = new Date()
      this.saveSessions()
    }
  }
  
  // æ›´æ–°ä¼šè¯ä¹¦ç±ä¿¡æ¯
  updateCurrentSessionBookInfo(bookName: string, bookInfo: Object): void {
    const currentSession = this.getCurrentSession()
    if (currentSession) {
      currentSession.bookName = bookName
      currentSession.bookInfo = bookInfo
      // ä½¿ç”¨ä¹¦ç±åç§°ä½œä¸ºä¼šè¯æ ‡é¢˜
      currentSession.title = `ðŸ“š ${bookName}`
      currentSession.updatedAt = new Date()
      this.saveSessions()
    }
  }
  
  // èŽ·å–ç”¨äºŽAPIçš„èŠå¤©åŽ†å²
  getChatHistoryForAPI(sessionId: string): ChatMessage[] {
    const session = this.sessions.find(s => s.id === sessionId)
    if (!session) {
      return []
    }
    
    return session.messages.map((msg: QAMessage): ChatMessage => ({
      role: msg.type === 'question' ? 'user' : 'assistant',
      content: msg.content
    }))
  }
  
  // èŽ·å–å½“å‰ä¼šè¯çš„èŠå¤©åŽ†å²
  getCurrentChatHistoryForAPI(): ChatMessage[] {
    return this.getChatHistoryForAPI(this.currentSessionId)
  }
  
  // ç”ŸæˆID
  private generateId(): string {
    return Date.now().toString(36) + Math.random().toString(36).substr(2)
  }
  
  // èŽ·å–ä¼šè¯ç»Ÿè®¡
  getSessionStats(): SessionStats {
    const totalMessages = this.sessions.reduce((sum: number, session: ClientChatSession) => sum + session.messages.length, 0)
    return {
      total: this.sessions.length,
      totalMessages: totalMessages
    }
  }
}

export interface SessionStats {
  total: number
  totalMessages: number
}