import { BookInfo } from '../model/BookInfo'
import { QAMessage } from '../model/QAMessage'
import { ApiService } from '../services/ApiService'
import { QAComponent } from '../components/QAComponent'
import { LoadingComponent } from '../components/LoadingComponent'

@Entry
@Component
struct Index {
  @State bookInfo: BookInfo | null = null
  @State isLoading: boolean = false
  @State messages: QAMessage[] = []
  @State currentInput: string = ''
  private scroller: Scroller = new Scroller()
  private textInputController: TextInputController = new TextInputController()

  async processMessage() {
    if (!this.currentInput.trim()) {
      return
    }

    const input = this.currentInput.trim()
    this.currentInput = ''
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    this.messages.push(new QAMessage(input, 'question'))
    this.isLoading = true
    
    try {
      if (!this.bookInfo) {
        // é¦–æ¬¡é—®ç­”ï¼šæŸ¥è¯¢ä¹¦ç±ä¿¡æ¯
        this.bookInfo = await ApiService.getBookInfo(input)
        
        // æ·»åŠ ä¹¦ç±ä¿¡æ¯åˆ°æ¶ˆæ¯åˆ—è¡¨
        if (this.bookInfo) {
          const bookInfoText = `ðŸ“š ã€Š${this.bookInfo.title}ã€‹\n\n` +
            `ä½œè€…ï¼š${this.bookInfo.author || 'æœªçŸ¥'}\n` +
            `å‡ºç‰ˆç¤¾ï¼š${this.bookInfo.publisher || 'æœªçŸ¥'}\n` +
            `å‡ºç‰ˆå¹´ä»½ï¼š${this.bookInfo.year || 'æœªçŸ¥'}\n` +
            `ISBNï¼š${this.bookInfo.isbn || 'æœªçŸ¥'}\n\n` +
            `ç®€ä»‹ï¼š\n${this.bookInfo.description || 'æš‚æ— ç®€ä»‹'}\n\n` +
            `å†…å®¹æ¦‚è¿°ï¼š\n${this.bookInfo.summary || 'æš‚æ— æ¦‚è¿°'}`
          
          this.messages.push(new QAMessage(bookInfoText, 'answer'))
        }
      } else {
        // åŽç»­é—®ç­”ï¼šé’ˆå¯¹ä¹¦ç±è¿›è¡Œé—®ç­”
        const answer = await ApiService.askQuestion(this.bookInfo.title, input)
        this.messages.push(new QAMessage(answer, 'answer'))
      }
    } catch (error) {
      this.messages.push(new QAMessage('æŠ±æ­‰ï¼Œå¤„ç†å¤±è´¥ï¼š' + error.message, 'answer'))
    } finally {
      this.isLoading = false
      // å»¶è¿Ÿæ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿å†…å®¹å·²æ¸²æŸ“
      setTimeout(() => {
        this.scroller.scrollEdge(Edge.Bottom)
      }, 100)
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Text('AIè¯»ä¹¦åŠ©æ‰‹')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 16 })
      
      // èŠå¤©å†…å®¹åŒºåŸŸ
      Scroll(this.scroller) {
        Column() {
          ForEach(this.messages, (message: QAMessage) => {
            QAComponent({ message: message })
          })
        }
        .width('100%')
        .padding({ left: 12, right: 12 })
      }
      .layoutWeight(1)
      .width('100%')
      .scrollBar(BarState.Off)
      .align(Alignment.Top)
      
      // åº•éƒ¨åŠ è½½çŠ¶æ€
      if (this.isLoading) {
        LoadingComponent()
          .margin({ bottom: 8 })
      }
      
      // åº•éƒ¨è¾“å…¥åŒºåŸŸ
      Row() {
        TextInput({ 
          placeholder: this.bookInfo ? 'è¯·è¾“å…¥å…³äºŽè¿™æœ¬ä¹¦çš„é—®é¢˜' : 'è¯·è¾“å…¥ä¹¦ç±åç§°å¼€å§‹å¯¹è¯',
          controller: this.textInputController,
          text: this.currentInput
        })
          .layoutWeight(1)
          .height(40)
          .margin({ right: 10 })
          .enabled(!this.isLoading)
          .onChange((value: string) => {
            this.currentInput = value
          })
        
        Button('å‘é€')
          .width(80)
          .height(40)
          .enabled(!this.isLoading && this.currentInput.trim().length > 0)
          .onClick(() => {
            this.processMessage()
          })
      }
      .width('100%')
      .margin({ top: 8, bottom: 20 })
    }
    .padding(20)
    .width('100%')
    .height('100%')
  }
}