import { ClientSessionManager } from '../services/ClientSessionManager'
import { QAMessage } from '../model/QAMessage'
import { LoadingComponent } from '../components/LoadingComponent'

@Entry
@Component
struct TestPersistencePage {
  @State testResults: string[] = []
  @State isRunning: boolean = false
  
  private sessionManager = new ClientSessionManager()
  
  async aboutToAppear() {
    await this.runTests()
  }
  
  async runTests() {
    this.isRunning = true
    this.testResults = []
    
    try {
      // æµ‹è¯•1ï¼šåˆå§‹åŒ–ä¼šè¯ç®¡ç†å™¨
      this.addTestResult('ðŸ”§ åˆå§‹åŒ–ä¼šè¯ç®¡ç†å™¨...')
      await this.sessionManager.ensureInitialized()
      this.addTestResult('âœ… ä¼šè¯ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ')
      
      // æµ‹è¯•2ï¼šåˆ›å»ºæµ‹è¯•ä¼šè¯
      this.addTestResult('ðŸ“ åˆ›å»ºæµ‹è¯•ä¼šè¯...')
      const testSession = await this.sessionManager.createSession('ðŸ“š æµ‹è¯•ä¹¦ç±', 'æµ‹è¯•ä¹¦ç±')
      this.addTestResult(`âœ… ä¼šè¯åˆ›å»ºæˆåŠŸ: ${testSession.title}`)
      
      // æµ‹è¯•3ï¼šæ·»åŠ æµ‹è¯•æ¶ˆæ¯
      this.addTestResult('ðŸ’¬ æ·»åŠ æµ‹è¯•æ¶ˆæ¯...')
      const questionMessage = new QAMessage('è¿™æœ¬ä¹¦è®²äº†ä»€ä¹ˆï¼Ÿ', 'question')
      await this.sessionManager.addMessageToCurrentSession(questionMessage)
      
      const answerMessage = new QAMessage('è¿™æ˜¯ä¸€æœ¬å…³äºŽæµ‹è¯•çš„ä¹¦ç±', 'answer')
      await this.sessionManager.addMessageToCurrentSession(answerMessage)
      this.addTestResult('âœ… æµ‹è¯•æ¶ˆæ¯æ·»åŠ æˆåŠŸ')
      
      // æµ‹è¯•4ï¼šèŽ·å–ä¼šè¯åˆ—è¡¨
      this.addTestResult('ðŸ“‹ èŽ·å–ä¼šè¯åˆ—è¡¨...')
      const sessions = this.sessionManager.getAllSessions()
      this.addTestResult(`âœ… å½“å‰ä¼šè¯æ•°é‡: ${sessions.length}`)
      
      // æµ‹è¯•5ï¼šèŽ·å–å½“å‰ä¼šè¯
      this.addTestResult('ðŸ“– èŽ·å–å½“å‰ä¼šè¯...')
      const currentSession = this.sessionManager.getCurrentSession()
      if (currentSession) {
        this.addTestResult(`âœ… å½“å‰ä¼šè¯: ${currentSession.title}`)
        this.addTestResult(`âœ… æ¶ˆæ¯æ•°é‡: ${currentSession.messages.length}`)
      } else {
        this.addTestResult('âŒ èŽ·å–å½“å‰ä¼šè¯å¤±è´¥')
      }
      
      // æµ‹è¯•6ï¼šåˆ‡æ¢ä¼šè¯
      if (sessions.length > 1) {
        this.addTestResult('ðŸ”„ æµ‹è¯•åˆ‡æ¢ä¼šè¯...')
        const switchResult = await this.sessionManager.switchSession(sessions[0].id)
        if (switchResult) {
          this.addTestResult('âœ… ä¼šè¯åˆ‡æ¢æˆåŠŸ')
        } else {
          this.addTestResult('âŒ ä¼šè¯åˆ‡æ¢å¤±è´¥')
        }
      }
      
      // æµ‹è¯•7ï¼šèŽ·å–ä¼šè¯ç»Ÿè®¡
      this.addTestResult('ðŸ“Š èŽ·å–ä¼šè¯ç»Ÿè®¡...')
      const stats = this.sessionManager.getSessionStats()
      this.addTestResult(`âœ… ä¼šè¯æ€»æ•°: ${stats.total}`)
      this.addTestResult(`âœ… æ¶ˆæ¯æ€»æ•°: ${stats.totalMessages}`)
      
      this.addTestResult('ðŸŽ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼')
      
    } catch (error) {
      this.addTestResult(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`)
      console.error('Test error:', error)
    } finally {
      this.isRunning = false
    }
  }
  
  addTestResult(result: string) {
    this.testResults.push(result)
    console.log(result)
  }
  
  build() {
    Column() {
      Text('æŒä¹…åŒ–åŠŸèƒ½æµ‹è¯•')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20 })
      
      if (this.isRunning) {
        Row() {
          LoadingComponent()
          Text('æµ‹è¯•è¿è¡Œä¸­...')
            .fontSize(16)
            .margin({ left: 10 })
        }
        .margin({ bottom: 20 })
      }
      
      Scroll() {
        Column() {
          ForEach(this.testResults, (result: string) => {
            Text(result)
              .fontSize(14)
              .margin({ bottom: 8 })
              .width('100%')
          })
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#f5f5f5')
        .borderRadius(8)
      }
      .layoutWeight(1)
      .width('100%')
      
      Button('é‡æ–°è¿è¡Œæµ‹è¯•')
        .width('100%')
        .height(40)
        .margin({ top: 20 })
        .onClick(() => {
          this.runTests()
        })
    }
    .padding(20)
    .width('100%')
    .height('100%')
  }
}