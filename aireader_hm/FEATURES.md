# HarmonyOS AIè¯»ä¹¦åŠ©æ‰‹åŠŸèƒ½æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°
HarmonyOS AIè¯»ä¹¦åŠ©æ‰‹æ˜¯ä¸€ä¸ªåŸºäºArkTSå¼€å‘çš„æ™ºèƒ½å›¾ä¹¦é˜…è¯»åº”ç”¨ï¼Œæä¾›ä¹¦ç±ä¿¡æ¯æŸ¥è¯¢å’Œæ™ºèƒ½é—®ç­”åŠŸèƒ½ã€‚

## å·²å®ŒæˆåŠŸèƒ½

### 1. æ ¸å¿ƒåŠŸèƒ½
- âœ… **ä¹¦ç±ä¿¡æ¯æŸ¥è¯¢**: æ ¹æ®ä¹¦åæŸ¥è¯¢ä¹¦ç±è¯¦ç»†ä¿¡æ¯ï¼ˆä½œè€…ã€å‡ºç‰ˆç¤¾ã€ISBNã€ç®€ä»‹ã€å†…å®¹æ¦‚è¿°ï¼‰
- âœ… **æ™ºèƒ½é—®ç­”**: é’ˆå¯¹ç‰¹å®šä¹¦ç±è¿›è¡ŒAIé—®ç­”äº¤äº’
- âœ… **ç»Ÿä¸€èŠå¤©ç•Œé¢**: é›†æˆä¹¦ç±æŸ¥è¯¢å’Œé—®ç­”åŠŸèƒ½äºå•ä¸€ç•Œé¢
- âœ… **è‡ªåŠ¨æ»šåŠ¨**: æ¯æ¬¡å›å¤åè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
- âœ… **è¾“å…¥æ¡†è‡ªåŠ¨æ¸…é™¤**: å‘é€æ¶ˆæ¯åè‡ªåŠ¨æ¸…ç©ºè¾“å…¥æ¡†å†…å®¹
- âœ… **ä¸€é”®ç”Ÿæˆä¹¦ç±æŠ¥å‘Š**: åœ¨è·å–ä¹¦ç±ä¿¡æ¯åï¼Œå¯ä¸€é”®ç”Ÿæˆä¸€ä»½è¯¦ç»†çš„ä¹¦ç±åˆ†ææŠ¥å‘Šã€‚

### 2. ç”¨æˆ·ç•Œé¢
- âœ… **å“åº”å¼å¸ƒå±€**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸
- âœ… **æ¶ˆæ¯åŒºåˆ†**: ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤é‡‡ç”¨ä¸åŒæ ·å¼æ˜¾ç¤º
- âœ… **åŠ è½½çŠ¶æ€**: è¯·æ±‚å¤„ç†æ—¶æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
- âœ… **è¾“å…¥éªŒè¯**: é˜²æ­¢ç©ºæ¶ˆæ¯å‘é€
- âœ… **å›¾æ ‡åŒ–å¯¼èˆª**: å·¦ä¾§ä¼šè¯åˆ—è¡¨å›¾æ ‡æŒ‰é’®ï¼Œå³ä¸Šè§’æ–°å»ºä¼šè¯æŒ‰é’®
- âœ… **ä¾§è¾¹æ è®¾è®¡**: ä¼šè¯åˆ—è¡¨ä»å·¦ä¾§æ»‘å‡ºï¼Œç¬¦åˆç”¨æˆ·ä¹ æƒ¯
- âœ… **ä¹¦ç±å‘½å**: ä¼šè¯åˆ—è¡¨ä½¿ç”¨ä¹¦ç±åç§°ä½œä¸ºæ ‡é¢˜ï¼Œä¾¿äºè¯†åˆ«
- âœ… **é‡å¤æ¶ˆæ¯ä¿®å¤**: è§£å†³äº†æ¶ˆæ¯é‡å¤æ˜¾ç¤ºçš„é—®é¢˜
- âœ… **æ™ºèƒ½é—®ç­”å¿«æ·æ–¹å¼**: åœ¨è·å–ä¹¦ç±ä¿¡æ¯åï¼Œæä¾›æ¨èé—®é¢˜ï¼Œç®€åŒ–ç”¨æˆ·æ“ä½œ
- âœ… **çº¯æ–‡æœ¬å›å¤ä¼˜åŒ–**: ä¼˜åŒ–AIæç¤ºè¯ï¼Œç¡®ä¿å›å¤ä¸ºçº¯æ–‡æœ¬ï¼Œæ”¹å–„Appå†…å±•ç¤ºæ•ˆæœ

### 3. Markdownæ¸²æŸ“
- âœ… **æ ‡é¢˜æ”¯æŒ**: H1ã€H2ã€H3æ ‡é¢˜æ ¼å¼
- âœ… **æ–‡æœ¬æ ¼å¼**: ç²—ä½“ã€æ–œä½“ã€è¡Œå†…ä»£ç 
- âœ… **åˆ—è¡¨**: æ— åºåˆ—è¡¨å’Œæœ‰åºåˆ—è¡¨
- âœ… **ä»£ç å—**: å¤šè¡Œä»£ç å—æ˜¾ç¤º
- âœ… **å¼•ç”¨**: å¼•ç”¨å—æ˜¾ç¤º
- âœ… **æ®µè½**: æ™®é€šæ®µè½æ–‡æœ¬
- âœ… **å®Œæ•´å†…å®¹æ˜¾ç¤º**: æ— å¤§å°é™åˆ¶ï¼Œå®Œæ•´å±•ç¤ºå†…å®¹

### 4. æŠ€æœ¯ç‰¹æ€§
- âœ… **çŠ¶æ€ç®¡ç†**: ä½¿ç”¨@Stateã€@Propè£…é¥°å™¨ç®¡ç†ç»„ä»¶çŠ¶æ€
- âœ… **å¼‚æ­¥å¤„ç†**: async/awaitå¤„ç†APIè¯·æ±‚
- âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸æ•è·å’Œç”¨æˆ·æç¤º
- âœ… **ç»„ä»¶åŒ–**: å¯å¤ç”¨çš„UIç»„ä»¶è®¾è®¡
- âœ… **å¤šè½®å¯¹è¯è®°å¿†**: å®Œæ•´çš„ä¼šè¯ç®¡ç†å’Œæ¶ˆæ¯å†å²è®°å½•
- âœ… **å›¾æ ‡åŒ–ç•Œé¢**: ç›´è§‚çš„å›¾æ ‡æŒ‰é’®è®¾è®¡
- âœ… **å“åº”å¼å¸ƒå±€**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸å’Œäº¤äº’éœ€æ±‚
- âœ… **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨é¸¿è’™Preferences APIä¿å­˜ä¼šè¯æ•°æ®
- âœ… **åº”ç”¨é‡å¯æ¢å¤**: ä¸‹æ¬¡æ‰“å¼€åº”ç”¨æ—¶è‡ªåŠ¨æ¢å¤å†å²ä¼šè¯
- âœ… **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ArkTSå¼ºç±»å‹å®ç°ï¼Œç¬¦åˆç¼–è¯‘å™¨è¦æ±‚
- âœ… **å•ä¾‹æ¨¡å¼**: StorageManagerå•ä¾‹ç¡®ä¿æ•°æ®ç®¡ç†ä¸€è‡´æ€§
- âœ… **åºåˆ—åŒ–å®‰å…¨**: å®Œæ•´çš„æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–æœºåˆ¶
- âœ… **æ™ºèƒ½ä¹¦ç±æŸ¥æ‰¾**: é€šè¿‡AIæ¨¡å‹è¿”å›çš„`is_found`æ ‡å¿—ä½ï¼Œç²¾ç¡®åˆ¤æ–­ä¹¦ç±æ˜¯å¦æ‰¾åˆ°ï¼Œå¹¶å‘ç”¨æˆ·å±•ç¤ºæ˜ç¡®çš„æŸ¥æ‰¾å¤±è´¥åŸå› ï¼Œæå‡äº†ç”¨æˆ·ä½“éªŒã€‚

## æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. é¡¹ç›®æ¶æ„
```
entry/
â”œâ”€â”€ src/main/ets/
â”‚   â”œâ”€â”€ components/          # UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ QAComponent.ets          # èŠå¤©æ¶ˆæ¯ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ MarkdownRenderer.ets     # Markdownæ¸²æŸ“å™¨
â”‚   â”‚   â”œâ”€â”€ SimpleMarkdownRenderer.ets # ç®€åŒ–Markdownæ¸²æŸ“å™¨
â”‚   â”‚   â”œâ”€â”€ LoadingComponent.ets     # åŠ è½½åŠ¨ç”»ç»„ä»¶
â”‚   â”‚   â””â”€â”€ SessionListComponent.ets # ä¼šè¯åˆ—è¡¨ç»„ä»¶
â”‚   â”œâ”€â”€ model/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ BookInfo.ets             # ä¹¦ç±ä¿¡æ¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ QAMessage.ets            # èŠå¤©æ¶ˆæ¯æ¨¡å‹
â”‚   â”‚   â””â”€â”€ ChatModels.ets           # å¯¹è¯è®°å¿†æ¨¡å‹
â”‚   â”œâ”€â”€ pages/              # é¡µé¢
â”‚   â”‚   â”œâ”€â”€ Index.ets                # ä¸»é¡µé¢
â”‚   â”‚   â””â”€â”€ TestPersistencePage.ets  # æŒä¹…åŒ–åŠŸèƒ½æµ‹è¯•é¡µé¢
â”‚   â”œâ”€â”€ services/           # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ ApiService.ets          # APIæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ StorageManager.ets      # æ•°æ®æŒä¹…åŒ–ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ ClientSessionManager.ets # ä¼šè¯ç®¡ç†å™¨
â”‚   â””â”€â”€ utils/              # å·¥å…·ç±»
â”‚       â””â”€â”€ MarkdownUtils.ets        # Markdownè§£æå·¥å…·
```

### 2. æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 2.1 Indexé¡µé¢ (ä¸»ç•Œé¢)
```typescript
@Component
struct Index {
  @State bookInfo: BookInfo | null = null        // å½“å‰ä¹¦ç±ä¿¡æ¯
  @State isLoading: boolean = false              // åŠ è½½çŠ¶æ€
  @State messages: QAMessage[] = []              // æ¶ˆæ¯åˆ—è¡¨
  @State currentInput: string = ''               // å½“å‰è¾“å…¥
  private scroller: Scroller = new Scroller()    // æ»šåŠ¨æ§åˆ¶å™¨
  private textInputController: TextInputController = new TextInputController()
}
```

**å…³é”®åŠŸèƒ½å®ç°**:
- **æ™ºèƒ½æ¶ˆæ¯å¤„ç†**: æ ¹æ®`bookInfo`çŠ¶æ€åˆ¤æ–­æ˜¯é¦–æ¬¡æŸ¥è¯¢ä¹¦ç±è¿˜æ˜¯åç»­é—®ç­”
- **è‡ªåŠ¨æ»šåŠ¨**: ä½¿ç”¨`setTimeout`å»¶è¿Ÿè°ƒç”¨`scroller.scrollEdge(Edge.Bottom)`
- **è¾“å…¥æ¡†ç»‘å®š**: é€šè¿‡`text: this.currentInput`å®ç°åŒå‘ç»‘å®š

#### 2.2 QAComponent (èŠå¤©æ¶ˆæ¯ç»„ä»¶)
```typescript
@Component
export struct QAComponent {
  @Prop message: QAMessage
}
```

**è®¾è®¡ç‰¹ç‚¹**:
- **æ¡ä»¶æ¸²æŸ“**: æ ¹æ®`message.type`åŒºåˆ†ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤
- **å¸ƒå±€é€‚é…**: ç”¨æˆ·æ¶ˆæ¯å³å¯¹é½ï¼ŒAIå›å¤å·¦å¯¹é½
- **Markdowné›†æˆ**: AIå›å¤ä½¿ç”¨`MarkdownRenderer`è¿›è¡Œå¯Œæ–‡æœ¬æ¸²æŸ“

#### 2.3 MarkdownRenderer (Markdownæ¸²æŸ“å™¨)
```typescript
@Component
export struct MarkdownRenderer {
  @Prop content: string
  private elements: MarkdownElement[] = []
  
  aboutToAppear() {
    this.elements = MarkdownUtils.parseMarkdown(this.content)
  }
}
```

**æ¸²æŸ“èƒ½åŠ›**:
- **å¤šå…ƒç´ æ”¯æŒ**: é€šè¿‡`ForEach`å¾ªç¯æ¸²æŸ“ä¸åŒç±»å‹çš„Markdownå…ƒç´ 
- **æ ¼å¼åŒ–æ–‡æœ¬**: æ”¯æŒç²—ä½“ã€æ–œä½“ã€ä»£ç ç­‰å†…è”æ ¼å¼
- **Builderæ¨¡å¼**: ä½¿ç”¨`@Builder`æ–¹æ³•å°è£…ä¸åŒå…ƒç´ çš„æ¸²æŸ“é€»è¾‘

### 3. æ•°æ®æ¨¡å‹è®¾è®¡

#### 3.1 BookInfo (ä¹¦ç±ä¿¡æ¯)
```typescript
export interface BookInfo {
  title: string      // ä¹¦å
  author?: string    // ä½œè€…
  publisher?: string // å‡ºç‰ˆç¤¾
  year?: string      // å‡ºç‰ˆå¹´ä»½
  isbn?: string      // ISBN
  description?: string // ç®€ä»‹
  summary?: string   // å†…å®¹æ¦‚è¿°
}
```

#### 3.2 QAMessage (èŠå¤©æ¶ˆæ¯)
```typescript
export class QAMessage {
  content: string        // æ¶ˆæ¯å†…å®¹
  type: 'question' | 'answer' // æ¶ˆæ¯ç±»å‹
  timestamp?: Date       // æ—¶é—´æˆ³ï¼ˆå¯é€‰ï¼‰
}
```

### 4. APIæœåŠ¡è®¾è®¡

#### 4.1 ApiService (APIæœåŠ¡ç±»)
```typescript
export class ApiService {
  static async getBookInfo(bookName: string): Promise<BookInfo>
  static async askQuestion(bookName: string, question: string): Promise<string>
}
```

**æŠ€æœ¯ç‰¹ç‚¹**:
- **é™æ€æ–¹æ³•**: æ— éœ€å®ä¾‹åŒ–å³å¯è°ƒç”¨
- **Promiseè¿”å›**: æ”¯æŒå¼‚æ­¥æ“ä½œ
- **é”™è¯¯å¤„ç†**: å†…ç½®ç½‘ç»œè¯·æ±‚å¼‚å¸¸å¤„ç†

### 5. å·¥å…·ç±»è®¾è®¡

#### 5.1 MarkdownUtils (Markdownè§£æå·¥å…·)
```typescript
export class MarkdownUtils {
  static parseMarkdown(text: string): Array<MarkdownElement>
  private static extractCodeBlock(lines: string[], startIndex: number): CodeBlockResult
  private static parseInlineFormatting(text: string): string
}
```

**è§£æèƒ½åŠ›**:
- **è¡Œçº§è§£æ**: é€è¡Œè§£æMarkdownè¯­æ³•
- **å¤šè¡Œæ”¯æŒ**: å¤„ç†ä»£ç å—ç­‰å¤šè¡Œå…ƒç´ 
- **å†…è”æ ¼å¼**: è¯†åˆ«ç²—ä½“ã€æ–œä½“ã€ä»£ç ç­‰æ ¼å¼æ ‡è®°

### 6. å…³é”®æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

#### 6.1 è¾“å…¥æ¡†è‡ªåŠ¨æ¸…é™¤
**é—®é¢˜**: å‘é€æ¶ˆæ¯åè¾“å…¥æ¡†å†…å®¹æœªæ¸…é™¤
**è§£å†³æ–¹æ¡ˆ**: 
```typescript
// 1. æ·»åŠ TextInputController
private textInputController: TextInputController = new TextInputController()

// 2. ç»‘å®štextå±æ€§
TextInput({ 
  text: this.currentInput,
  controller: this.textInputController
})

// 3. å‘é€æ—¶æ¸…ç©ºçŠ¶æ€
this.currentInput = ''
```

#### 6.2 Markdownæ¸²æŸ“
**é—®é¢˜**: éœ€è¦æ”¯æŒå¯Œæ–‡æœ¬æ˜¾ç¤º
**è§£å†³æ–¹æ¡ˆ**:
- åˆ›å»ºä¸“é—¨çš„Markdownè§£æå’Œæ¸²æŸ“ç³»ç»Ÿ
- ä½¿ç”¨Builderæ¨¡å¼å¤„ç†ä¸åŒå…ƒç´ ç±»å‹
- æ”¯æŒå¸¸ç”¨çš„Markdownè¯­æ³•

#### 6.3 è‡ªåŠ¨æ»šåŠ¨
**é—®é¢˜**: æ–°æ¶ˆæ¯æ˜¾ç¤ºåéœ€è¦è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
**è§£å†³æ–¹æ¡ˆ**:
```typescript
setTimeout(() => {
  this.scroller.scrollEdge(Edge.Bottom)
}, 100)
```

#### 6.4 ç»Ÿä¸€èŠå¤©ç•Œé¢
**é—®é¢˜**: åŸè®¾è®¡åˆ†ç¦»ä¹¦ç±æŸ¥è¯¢å’Œé—®ç­”åŠŸèƒ½
**è§£å†³æ–¹æ¡ˆ**:
- ç§»é™¤ç‹¬ç«‹çš„QAPage
- åœ¨Indexé¡µé¢é›†æˆæ‰€æœ‰åŠŸèƒ½
- é€šè¿‡bookInfoçŠ¶æ€åˆ¤æ–­å¤„ç†é€»è¾‘

### 7. å¤šè½®å¯¹è¯è®°å¿†åŠŸèƒ½

#### 7.1 åŠŸèƒ½æ¦‚è¿°
- âœ… **ä¼šè¯ç®¡ç†**: åˆ›å»ºã€åˆ‡æ¢ã€åˆ é™¤å¯¹è¯ä¼šè¯
- âœ… **æ¶ˆæ¯å†å²**: å®Œæ•´çš„å¯¹è¯è®°å½•å­˜å‚¨å’Œæ£€ç´¢
- âœ… **ä¸Šä¸‹æ–‡è®°å¿†**: AIèƒ½è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹
- âœ… **ä¼šè¯åˆ—è¡¨**: ä¾§è¾¹æ æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯
- âœ… **çŠ¶æ€æ¢å¤**: åˆ‡æ¢ä¼šè¯æ—¶æ¢å¤å®Œæ•´å¯¹è¯å†å²

#### 7.2 æŠ€æœ¯æ¶æ„

##### åç«¯å®ç°
```python
# æ•°æ®æ¨¡å‹
class ChatSession:
    - id: ä¼šè¯ID
    - title: ä¼šè¯æ ‡é¢˜
    - book_name: ä¹¦ç±åç§°
    - message_count: æ¶ˆæ¯æ•°é‡
    - created_at: åˆ›å»ºæ—¶é—´
    - is_active: æ˜¯å¦æ´»è·ƒ

class ChatMessage:
    - id: æ¶ˆæ¯ID
    - session_id: ä¼šè¯ID
    - content: æ¶ˆæ¯å†…å®¹
    - type: æ¶ˆæ¯ç±»å‹
    - timestamp: æ—¶é—´æˆ³

# æœåŠ¡å±‚
class ChatMemoryService:
    - create_session(): åˆ›å»ºä¼šè¯
    - add_message(): æ·»åŠ æ¶ˆæ¯
    - get_conversation_context(): è·å–å¯¹è¯ä¸Šä¸‹æ–‡
    - get_session_messages(): è·å–ä¼šè¯æ¶ˆæ¯
```

##### å‰ç«¯å®ç°
```typescript
// æ•°æ®æ¨¡å‹
interface ChatSession {
  sessionId: string
  title: string
  bookName?: string
  messageCount: number
  createdAt: string
  isActive: boolean
}

// ç»„ä»¶
- SessionListComponent: ä¼šè¯åˆ—è¡¨ç»„ä»¶
- Index: ä¸»ç•Œé¢ï¼ˆé›†æˆä¼šè¯ç®¡ç†ï¼‰
```

##### APIæ¥å£
```typescript
// ä¼šè¯ç®¡ç†
POST /api/chat/session          // åˆ›å»ºä¼šè¯
GET  /api/chat/sessions         // è·å–ä¼šè¯åˆ—è¡¨
GET  /api/chat/session/{id}     // è·å–ç‰¹å®šä¼šè¯
DELETE /api/chat/session/{id}   // åˆ é™¤ä¼šè¯

// æ¶ˆæ¯ç®¡ç†
POST /api/chat/messages         // è·å–æ¶ˆæ¯å†å²
POST /api/chat/qa              // å¸¦ä¼šè¯çš„é—®ç­”
```

#### 7.3 æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

##### 7.3.1 ä¼šè¯ç®¡ç†
- **åˆ›å»ºä¼šè¯**: æ”¯æŒè‡ªå®šä¹‰æ ‡é¢˜å’Œä¹¦ç±åç§°
- **åˆ‡æ¢ä¼šè¯**: å®æ—¶åˆ‡æ¢å¹¶æ¢å¤å¯¹è¯å†å²
- **åˆ é™¤ä¼šè¯**: æ”¯æŒåˆ é™¤ä¸éœ€è¦çš„ä¼šè¯
- **ä¼šè¯æŒä¹…åŒ–**: åç«¯å­˜å‚¨ç¡®ä¿æ•°æ®ä¸ä¸¢å¤±

##### 7.3.2 å¯¹è¯ä¸Šä¸‹æ–‡
- **è®°å¿†èƒ½åŠ›**: AIèƒ½è®°ä½åŒä¸€ä¼šè¯ä¸­çš„æ‰€æœ‰å¯¹è¯
- **ä¸Šä¸‹æ–‡ä¼ é€’**: å°†å¯¹è¯å†å²ä¼ é€’ç»™GeminiæœåŠ¡
- **æ™ºèƒ½å›å¤**: åŸºäºå†å²å¯¹è¯æä¾›æ›´å‡†ç¡®çš„å›ç­”
- **é•¿åº¦æ§åˆ¶**: é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦é¿å…è¶…å‡ºtokené™åˆ¶

##### 7.3.3 ç”¨æˆ·ç•Œé¢
- **ä¾§è¾¹æ è®¾è®¡**: æ»‘åŠ¨å¼ä¼šè¯åˆ—è¡¨
- **ä¼šè¯ä¿¡æ¯**: æ˜¾ç¤ºæ¶ˆæ¯æ•°é‡ã€æ—¶é—´ã€ä¹¦ç±ä¿¡æ¯
- **çŠ¶æ€æŒ‡ç¤º**: å½“å‰é€‰ä¸­ä¼šè¯é«˜äº®æ˜¾ç¤º
- **å“åº”å¼å¸ƒå±€**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸

#### 7.4 å…³é”®æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

##### 7.4.1 å¯¹è¯ä¸Šä¸‹æ–‡æ„å»º
**é—®é¢˜**: éœ€è¦å°†å†å²å¯¹è¯ä¼ é€’ç»™AIä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§
**è§£å†³æ–¹æ¡ˆ**:
```python
def get_conversation_context(self, session_id: str, max_messages: int = 10) -> str:
    messages = self.get_session_messages(session_id, limit=max_messages)
    
    context_parts = []
    for msg in messages:
        if msg.type == MessageType.QUESTION:
            context_parts.append(f"ç”¨æˆ·: {msg.content}")
        elif msg.type == MessageType.ANSWER:
            context_parts.append(f"åŠ©æ‰‹: {msg.content}")
    
    return "\n".join(context_parts)
```

##### 7.4.2 ä¼šè¯çŠ¶æ€ç®¡ç†
**é—®é¢˜**: å‰ç«¯éœ€è¦ç®¡ç†å¤æ‚çš„ä¼šè¯çŠ¶æ€
**è§£å†³æ–¹æ¡ˆ**:
```typescript
@State currentSessionId: string = ''
@State sessions: ChatSession[] = []
@State messages: QAMessage[] = []

async switchSession(session: ChatSession) {
  this.currentSessionId = session.sessionId
  this.bookInfo = session.bookName ? new BookInfo(session.bookInfo) : null
  await this.loadSessionMessages(session.sessionId)
}
```

##### 7.4.3 AIæç¤ºè¯ä¼˜åŒ–
**é—®é¢˜**: éœ€è¦è®©AIç†è§£å¯¹è¯å†å²å¹¶æä¾›è¿è´¯å›ç­”
**è§£å†³æ–¹æ¡ˆ**:
```python
def _build_qa_prompt_with_context(self, book_name: str, question: str, context: str) -> str:
    context_section = f"""å¯¹è¯å†å²ï¼š
{context}

""" if context.strip() else ""
    
    return f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾ä¹¦é˜…è¯»åŠ©æ‰‹ã€‚{context_section}ä¹¦ç±åç§°ï¼š{book_name}
ç”¨æˆ·é—®é¢˜ï¼š{question}

è¯·åŸºäºè¿™æœ¬ä¹¦çš„å†…å®¹å’Œç›¸å…³ä¿¡æ¯ï¼Œå‡†ç¡®ã€è¯¦ç»†åœ°å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚å›ç­”æ—¶è¦è€ƒè™‘ä¹‹å‰çš„å¯¹è¯å†å²ï¼Œä¿æŒè¿è´¯æ€§å’Œä¸Šä¸‹æ–‡å…³è”æ€§ã€‚"""
```

### 8. æ•°æ®æŒä¹…åŒ–åŠŸèƒ½

#### 8.1 åŠŸèƒ½æ¦‚è¿°
- âœ… **æœ¬åœ°å­˜å‚¨**: ä½¿ç”¨é¸¿è’™ç³»ç»ŸPreferences APIä¿å­˜ä¼šè¯æ•°æ®
- âœ… **è‡ªåŠ¨æ¢å¤**: åº”ç”¨é‡å¯åè‡ªåŠ¨æ¢å¤å†å²ä¼šè¯è®°å½•
- âœ… **å®Œæ•´æ€§ä¿å­˜**: ä¿å­˜ä¼šè¯ä¿¡æ¯ã€æ¶ˆæ¯å†å²ã€ä¹¦ç±ä¿¡æ¯ç­‰å®Œæ•´æ•°æ®
- âœ… **å‘åå…¼å®¹**: ä¿æŒåŸæœ‰AppStorageæœºåˆ¶çš„å…¼å®¹æ€§
- âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„å­˜å‚¨å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·æç¤º

#### 8.2 æŠ€æœ¯æ¶æ„

##### å­˜å‚¨ç®¡ç†å™¨
```typescript
// StorageManager.ets - å•ä¾‹æ¨¡å¼çš„æ•°æ®æŒä¹…åŒ–ç®¡ç†å™¨
export class StorageManager {
  private static instance: StorageManager
  private dataStore: preferences.Preferences | null = null
  private readonly STORE_NAME = 'chat_sessions_store'
  
  // æ ¸å¿ƒæ–¹æ³•
  async saveSessions(sessions: ClientChatSession[]): Promise<boolean>
  async loadSessions(): Promise<ClientChatSession[]>
  async saveCurrentSessionId(sessionId: string): Promise<boolean>
  async loadCurrentSessionId(): Promise<string>
  async clearAllData(): Promise<boolean>
}
```

##### ä¼šè¯ç®¡ç†å™¨é›†æˆ
```typescript
// ClientSessionManager.ets - é›†æˆæŒä¹…åŒ–åŠŸèƒ½çš„ä¼šè¯ç®¡ç†å™¨
export class ClientSessionManager {
  private storageManager: StorageManager
  private isInitialized: boolean = false
  
  // å¼‚æ­¥åˆå§‹åŒ–
  private async initializeStorage()
  
  // æŒä¹…åŒ–ä¿å­˜
  private async saveSessions()
  
  // æŒä¹…åŒ–åŠ è½½
  private async loadSessions()
}
```

##### åº”ç”¨ç”Ÿå‘½å‘¨æœŸé›†æˆ
```typescript
// EntryAbility.ets - åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–å­˜å‚¨
export default class EntryAbility extends UIAbility {
  async onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): Promise<void> {
    // åˆå§‹åŒ–å­˜å‚¨ç®¡ç†å™¨
    const storageManager = StorageManager.getInstance()
    await storageManager.init(this.context)
  }
}
```

#### 8.3 æ•°æ®åºåˆ—åŒ–ä¸ååºåˆ—åŒ–

##### æ•°æ®åºåˆ—åŒ–
```typescript
// åºåˆ—åŒ–ä¼šè¯æ•°æ®ä¸ºJSONæ ¼å¼
const serializedSessions = sessions.map(session => ({
  id: session.id,
  title: session.title,
  bookName: session.bookName,
  bookInfo: session.bookInfo,
  messages: session.messages.map(msg => ({
    content: msg.content,
    type: msg.type,
    timestamp: msg.timestamp ? msg.timestamp.toISOString() : null
  })),
  createdAt: session.createdAt.toISOString(),
  updatedAt: session.updatedAt.toISOString(),
  isActive: session.isActive
}))
```

##### æ•°æ®ååºåˆ—åŒ–
```typescript
// ååºåˆ—åŒ–JSONæ•°æ®ä¸ºä¼šè¯å¯¹è±¡
const sessions: ClientChatSession[] = serializedSessions.map(sessionData => ({
  id: sessionData.id,
  title: sessionData.title,
  bookName: sessionData.bookName,
  bookInfo: sessionData.bookInfo,
  messages: (sessionData.messages || []).map((msg: any) => ({
    content: msg.content,
    type: msg.type,
    timestamp: msg.timestamp ? new Date(msg.timestamp) : undefined
  })),
  createdAt: new Date(sessionData.createdAt),
  updatedAt: new Date(sessionData.updatedAt),
  isActive: sessionData.isActive
}))
```

#### 8.4 å…³é”®æŠ€æœ¯è§£å†³æ–¹æ¡ˆ

##### 8.4.1 å¼‚æ­¥åˆå§‹åŒ–ç®¡ç†
**é—®é¢˜**: éœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶å®‰å…¨åœ°åˆå§‹åŒ–å­˜å‚¨ç³»ç»Ÿ
**è§£å†³æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨Promiseç®¡ç†å¼‚æ­¥åˆå§‹åŒ–
private initializationPromise: Promise<void>

constructor() {
  this.storageManager = StorageManager.getInstance()
  this.initializationPromise = this.initializeStorage()
}

// æä¾›åˆå§‹åŒ–å®Œæˆæ£€æŸ¥æ–¹æ³•
async ensureInitialized(): Promise<void> {
  await this.initializationPromise
}
```

##### 8.4.2 åŒé‡å­˜å‚¨æœºåˆ¶
**é—®é¢˜**: éœ€è¦ä¿è¯æ•°æ®æŒä¹…åŒ–çš„åŒæ—¶ä¿æŒå‘åå…¼å®¹æ€§
**è§£å†³æ–¹æ¡ˆ**:
```typescript
// åŒæ—¶ä¿å­˜åˆ°AppStorageå’ŒæŒä¹…åŒ–å­˜å‚¨
private async saveSessions() {
  // ä¿å­˜åˆ°AppStorageï¼ˆå‘åå…¼å®¹ï¼‰
  AppStorage.Set('chatSessions', this.sessions)
  AppStorage.Set('currentSessionId', this.currentSessionId)
  
  // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
  await this.storageManager.saveSessions(this.sessions)
  await this.storageManager.saveCurrentSessionId(this.currentSessionId)
}
```

##### 8.4.3 æ•°æ®å®Œæ•´æ€§ä¿è¯
**é—®é¢˜**: éœ€è¦ç¡®ä¿æ•°æ®åœ¨å­˜å‚¨å’Œè¯»å–è¿‡ç¨‹ä¸­çš„å®Œæ•´æ€§
**è§£å†³æ–¹æ¡ˆ**:
```typescript
// å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ•°æ®éªŒè¯
async saveSessions(sessions: ClientChatSession[]): Promise<boolean> {
  try {
    // æ•°æ®åºåˆ—åŒ–å’ŒéªŒè¯
    const serializedSessions = sessions.map(session => ({...}))
    
    // åŸå­æ€§ä¿å­˜æ“ä½œ
    await this.dataStore.put(this.SESSIONS_KEY, JSON.stringify(serializedSessions))
    await this.dataStore.flush()
    
    return true
  } catch (error) {
    console.error('Failed to save sessions:', error)
    return false
  }
}
```

#### 8.5 åŠŸèƒ½æµ‹è¯•

##### 8.5.1 æµ‹è¯•è¦†ç›–
- âœ… å­˜å‚¨ç®¡ç†å™¨åˆå§‹åŒ–æµ‹è¯•
- âœ… ä¼šè¯æ•°æ®ä¿å­˜å’ŒåŠ è½½æµ‹è¯•
- âœ… ä¼šè¯IDä¿å­˜å’ŒåŠ è½½æµ‹è¯•
- âœ… æ•°æ®å­˜åœ¨æ€§æ£€æŸ¥æµ‹è¯•
- âœ… æ•°æ®æ¸…ç†æµ‹è¯•

##### 8.5.2 æµ‹è¯•ç»“æœ
- âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡
- âœ… æ•°æ®æŒä¹…åŒ–æˆåŠŸ
- âœ… åº”ç”¨é‡å¯åæ•°æ®æ­£ç¡®æ¢å¤
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸å·¥ä½œ

### 9. å¼€å‘æ³¨æ„äº‹é¡¹

#### 7.1 ArkTSè¯­æ³•é™åˆ¶
- **ä¸¥æ ¼ç±»å‹æ£€æŸ¥**: éœ€è¦æ˜ç¡®å®šä¹‰æ‰€æœ‰ç±»å‹
- **UIç»„ä»¶é™åˆ¶**: åªèƒ½åœ¨build()æ–¹æ³•ä¸­å†™UIç»„ä»¶è¯­æ³•
- **å±æ€§é™åˆ¶**: æŸäº›å±æ€§å¯èƒ½ä¸å­˜åœ¨æˆ–åç§°ä¸åŒ

#### 7.2 æ€§èƒ½ä¼˜åŒ–
- **ç»„ä»¶å¤ç”¨**: ä½¿ç”¨@Componentè£…é¥°å™¨åˆ›å»ºå¯å¤ç”¨ç»„ä»¶
- **çŠ¶æ€ç®¡ç†**: åˆç†ä½¿ç”¨@Stateå’Œ@Propè£…é¥°å™¨
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨async/awaité¿å…é˜»å¡UI

#### 7.3 ç”¨æˆ·ä½“éªŒ
- **å³æ—¶åé¦ˆ**: åŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º
- **æµç•…äº¤äº’**: è‡ªåŠ¨æ»šåŠ¨å’Œè¾“å…¥æ¡†æ¸…é™¤
- **æ¸…æ™°ç•Œé¢**: æ¶ˆæ¯ç±»å‹åŒºåˆ†å’Œæ ·å¼è®¾è®¡

## æœªæ¥æ‰©å±•è®¡åˆ’

### 1. åŠŸèƒ½å¢å¼º
- [ ] ä¹¦ç±æœç´¢å†å²è®°å½•
- [ ] æ¶ˆæ¯æ”¶è—åŠŸèƒ½
- [ ] ä¹¦ç±åˆ†ç±»æµè§ˆ
- [x] å¤šè½®å¯¹è¯è®°å¿†

### 2. ç•Œé¢ä¼˜åŒ–
- [x] å›¾æ ‡åŒ–å¯¼èˆªç•Œé¢
- [x] å·¦ä¾§ä¼šè¯åˆ—è¡¨
- [x] ä¹¦ç±åç§°ä¼šè¯æ ‡é¢˜
- [x] å¿«é€Ÿæ–°å»ºä¼šè¯æŒ‰é’®
- [ ] æ·±è‰²æ¨¡å¼æ”¯æŒ
- [ ] å­—ä½“å¤§å°è°ƒèŠ‚
- [ ] æ¶ˆæ¯é•¿æŒ‰èœå•
- [ ] åˆ†äº«åŠŸèƒ½

### 3. æŠ€æœ¯æ”¹è¿›
- [x] æœ¬åœ°æ•°æ®ç¼“å­˜
- [ ] ç½‘ç»œçŠ¶æ€æ£€æµ‹
- [ ] ç¦»çº¿æ¨¡å¼æ”¯æŒ
- [ ] æ€§èƒ½ç›‘æ§

## æ€»ç»“

å½“å‰ç‰ˆæœ¬å·²å®ç°äº†HarmonyOS AIè¯»ä¹¦åŠ©æ‰‹çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¹¦ç±æŸ¥è¯¢ã€æ™ºèƒ½é—®ç­”ã€Markdownæ¸²æŸ“ç­‰å…³é”®æŠ€æœ¯ç‰¹æ€§ã€‚é€šè¿‡ç»Ÿä¸€èŠå¤©ç•Œé¢è®¾è®¡ï¼Œæä¾›äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

### æœ€æ–°ç‰ˆæœ¬äº®ç‚¹ (v3.0)
- **ğŸ’¾ æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨é¸¿è’™Preferences APIå®ç°çœŸæ­£çš„æœ¬åœ°æ•°æ®å­˜å‚¨
- **ğŸ”„ è‡ªåŠ¨æ¢å¤**: åº”ç”¨é‡å¯åè‡ªåŠ¨æ¢å¤æ‰€æœ‰ä¼šè¯å†å²è®°å½•
- **ğŸ›¡ï¸ ç±»å‹å®‰å…¨**: å®Œæ•´çš„ArkTSå¼ºç±»å‹å®ç°ï¼Œé€šè¿‡æ‰€æœ‰ç¼–è¯‘å™¨æ£€æŸ¥
- **ğŸ”§ å•ä¾‹æ¶æ„**: StorageManagerå•ä¾‹æ¨¡å¼ç¡®ä¿æ•°æ®ç®¡ç†ä¸€è‡´æ€§
- **ğŸ“Š å®Œæ•´æµ‹è¯•**: ä¸“é—¨çš„æµ‹è¯•é¡µé¢éªŒè¯æ‰€æœ‰æŒä¹…åŒ–åŠŸèƒ½
- **âš¡ æ€§èƒ½ä¼˜åŒ–**: å¼‚æ­¥æ“ä½œç¡®ä¿ç”¨æˆ·ç•Œé¢å“åº”æµç•…

### v2.0 ç‰ˆæœ¬äº®ç‚¹
- **ğŸ¨ å…¨æ–°UIè®¾è®¡**: å›¾æ ‡åŒ–å¯¼èˆªç•Œé¢ï¼Œæ›´ç›´è§‚çš„ç”¨æˆ·äº¤äº’
- **ğŸ“š æ™ºèƒ½ä¼šè¯ç®¡ç†**: è‡ªåŠ¨ä½¿ç”¨ä¹¦ç±åç§°ä½œä¸ºä¼šè¯æ ‡é¢˜ï¼Œä¾¿äºè¯†åˆ«å’Œç®¡ç†
- **âš¡ ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**: è§£å†³æ¶ˆæ¯é‡å¤æ˜¾ç¤ºé—®é¢˜ï¼Œæå‡äº¤äº’æµç•…åº¦
- **ğŸ”§ æŠ€æœ¯æ¶æ„å®Œå–„**: é‡‡ç”¨æ— çŠ¶æ€åç«¯æ¶æ„ï¼Œæ”¯æŒæ›´å¥½çš„æ‰©å±•æ€§å’Œè´Ÿè½½å‡è¡¡

ä»£ç ç»“æ„æ¸…æ™°ï¼Œé‡‡ç”¨ç»„ä»¶åŒ–å¼€å‘æ¨¡å¼ï¼Œä¾¿äºåç»­åŠŸèƒ½æ‰©å±•å’Œç»´æŠ¤ã€‚é¡¹ç›®éµå¾ªHarmonyOSå¼€å‘è§„èŒƒï¼Œç¡®ä¿äº†ä»£ç è´¨é‡å’Œç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§ã€‚